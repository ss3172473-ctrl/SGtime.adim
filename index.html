<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>ì„¸ì…˜ ì½”ë“œ ê´€ë¦¬ - ìˆœê³µì‹œê°„</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0"
    rel="stylesheet" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#6366f1",
            "primary-dark": "#4f46e5",
            "background-light": "#f3f4f6",
            "card-light": "#ffffff",
          },
          fontFamily: {
            sans: ['"Inter"', '"Noto Sans KR"', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <style>
    body {
      display: none;
    }

    /* Security: Hide content until hash check passes */
    .code-item {
      transition: all 0.2s;
    }

    .code-item:hover {
      transform: translateY(-2px);
    }

    .expired-item {
      opacity: 0.6;
      background-color: #f3f4f6 !important;
      border-color: #e5e7eb !important;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
  </style>
</head>

<body class="bg-background-light min-h-screen p-4 font-sans">

  <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

  <div class="max-w-6xl mx-auto">

    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold mb-2">
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-teal-600">ì„¸ì…˜ ì½”ë“œ ê´€ë¦¬</span>
        </h1>
        <p class="text-slate-500 text-sm">ê´€ë¦¬ì ëª¨ë“œ: ì½”ë“œë¥¼ ìƒì„±, ìˆ˜ì • ë° ê´€ë¦¬í•©ë‹ˆë‹¤. (KST ê¸°ì¤€)</p>
      </div>
    </header>

    <!-- Code Generation Section -->
    <section class="mb-8 bg-card-light rounded-xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
        <span class="material-symbols-rounded text-primary">add_circle</span>
        ìƒˆ ì½”ë“œ ìƒì„±
      </h2>

      <div class="space-y-4">
        <!-- Row 1: Basic Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="creator-name" class="block text-sm font-medium text-slate-700 mb-2">ìƒì„±ì ì´ë¦„ (í•™ìƒ)</label>
            <input type="text" id="creator-name" placeholder="ì˜ˆ: í™ê¸¸ë™"
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label for="parent-phone" class="block text-sm font-medium text-slate-700 mb-2">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</label>
            <input type="tel" id="parent-phone" placeholder="01012345678"
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>

        <!-- Row 2: Tags & Notes -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="tags-input" class="block text-sm font-medium text-slate-700 mb-2">ê·¸ë£¹ íƒœê·¸</label>
            <input type="text" id="tags-input" placeholder="#ì¤‘ë“±ë°˜ #ìˆ˜í•™A (ê³µë°± êµ¬ë¶„)"
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label for="notes-input" class="block text-sm font-medium text-slate-700 mb-2">ë¹„ê³ </label>
            <input type="text" id="notes-input" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥"
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>

        <!-- Row 3: Expiration -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">ì½”ë“œ ìœ íš¨ ê¸°ê°„ (KST)</label>
          <div class="flex flex-wrap gap-2 items-center">
            <button type="button"
              class="duration-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all"
              data-days="7">1ì£¼ì¼</button>
            <button type="button"
              class="duration-btn px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium transition-all ring-2 ring-primary ring-offset-1"
              data-days="30">1ê°œì›” (ê¸°ë³¸)</button>
            <button type="button"
              class="duration-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all"
              data-days="90">3ê°œì›”</button>
            <button type="button"
              class="duration-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all"
              data-value="custom">ì§ì ‘ ì„ íƒ</button>

            <input type="date" id="expiration-date"
              class="hidden px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 ml-2">
            <span id="selected-date-display" class="text-sm text-slate-500 ml-2 font-medium"></span>
          </div>
        </div>

        <button id="generate-code-btn"
          class="w-full py-3 px-6 bg-primary hover:bg-primary-dark text-white font-semibold rounded-xl transition-all shadow-lg shadow-primary/30 mt-2">
          ì½”ë“œ ìƒì„±
        </button>
        <div id="generate-result" class="hidden p-4 rounded-lg mt-4"></div>
      </div>
    </section>

    <!-- Filter Bar -->
    <div class="mb-4 overflow-x-auto pb-2">
      <div class="flex gap-2" id="filter-container"></div>
    </div>

    <!-- Codes List Section -->
    <section class="bg-card-light rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
          <span class="material-symbols-rounded text-primary">list</span>
          ìƒì„±ëœ ì½”ë“œ ëª©ë¡ <span id="list-count" class="text-sm text-slate-400 font-normal ml-2"></span>
        </h2>
        <div class="flex gap-2">
          <button id="refresh-btn"
            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-all flex items-center gap-2 text-sm">
            <span class="material-symbols-rounded text-lg">refresh</span> ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>
      <div id="codes-list" class="space-y-3">
        <div class="text-center py-8 text-slate-500">ë¡œë”© ì¤‘...</div>
      </div>
    </section>

  </div>

  <!-- Edit Modal -->
  <dialog id="edit-modal" class="p-0 rounded-xl shadow-2xl w-full max-w-lg bg-white overflow-hidden">
    <div class="border-b border-slate-100 p-4 flex justify-between items-center bg-slate-50">
      <h3 class="font-bold text-lg text-slate-800">ì½”ë“œ ì •ë³´ ìˆ˜ì •</h3>
      <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600"><span
          class="material-symbols-rounded">close</span></button>
    </div>
    <div class="p-6 space-y-4">
      <input type="hidden" id="edit-code-id">
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-xs font-semibold text-slate-500 mb-1">ì½”ë“œ</label><input type="text"
            id="edit-code-display" disabled
            class="w-full px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-500 font-mono"></div>
        <div><label class="block text-xs font-semibold text-slate-500 mb-1">ìƒì„±ì</label><input type="text"
            id="edit-creator" disabled
            class="w-full px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-500"></div>
      </div>
      <div><label class="block text-sm font-medium text-slate-700 mb-1">í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸</label><input type="tel"
          id="edit-phone" class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
      <div><label class="block text-sm font-medium text-slate-700 mb-1">ê·¸ë£¹ íƒœê·¸</label><input type="text" id="edit-tags"
          class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
      <div><label class="block text-sm font-medium text-slate-700 mb-1">ë¹„ê³ </label><input type="text" id="edit-notes"
          class="w-full px-3 py-2 border border-slate-200 rounded-lg"></div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">ë§Œë£Œ ì¼ì ë³€ê²½ (KST)</label>
        <input type="date" id="edit-expiration" class="w-full px-3 py-2 border border-slate-200 rounded-lg">
      </div>
    </div>
    <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
      <button onclick="closeEditModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg">ì·¨ì†Œ</button>
      <button onclick="saveEdit()"
        class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg">ì €ì¥í•˜ê¸°</button>
    </div>
  </dialog>

  <script>
    // ----------------------------------------------------------------
    // ğŸ”’ Security Check (Hash-based)
    // ----------------------------------------------------------------
    // SHA-256 Hash of "2626"
    const TARGET_HASH = "305800b71062b49b350208327a02ec378199b4cf35e60eeb971611bef4928394";

    async function checkPasscode() {
      const input = prompt("ê´€ë¦¬ì ì ‘ê·¼ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (!input) return fail();

      const msgBuffer = new TextEncoder().encode(input);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      if (hashHex === TARGET_HASH) {
        document.body.style.display = "block";
        loadCodes();
        autoCleanupExpired();
      } else {
        alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        fail();
      }
    }

    function fail() {
      document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><h1>Access Denied</h1></div>';
      document.body.style.display = "block";
    }

    // Initialize Security Check
    checkPasscode();

    // ----------------------------------------------------------------
    // Firebase Config
    // ----------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDm7PGchG-5o8EzgwbP6ZKy8j6NRlTbJUQ",
      authDomain: "sungongsigan-platform.firebaseapp.com",
      projectId: "sungongsigan-platform",
      storageBucket: "sungongsigan-platform.firebasestorage.app",
      messagingSenderId: "562021273221",
      appId: "1:562021273221:web:08be5821d804948c05a3ec",
      measurementId: "G-MX691RYEER"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;

    // ----------------------------------------------------------------
    // KST Timezone Helpers
    // ----------------------------------------------------------------
    function getKSTTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const kstOffset = 9 * 60 * 60 * 1000;
      return new Date(utc + kstOffset);
    }
    function getKSTEndOfDay(daysToAdd) {
      const kstNow = getKSTTime();
      kstNow.setDate(kstNow.getDate() + daysToAdd);
      kstNow.setHours(23, 59, 59, 999);
      return kstNow;
    }
    function parseKSTDateInput(dateString) {
      if (!dateString) return null;
      const targetDate = new Date(dateString);
      targetDate.setHours(23, 59, 59, 999);
      return targetDate;
    }

    // ----------------------------------------------------------------
    // Data State & Elements
    // ----------------------------------------------------------------
    let allCodes = [];
    let currentFilter = 'All';

    // Elements...
    const creatorNameInput = document.getElementById('creator-name');
    const parentPhoneInput = document.getElementById('parent-phone');
    const tagsInput = document.getElementById('tags-input');
    const notesInput = document.getElementById('notes-input');
    const expirationDateInput = document.getElementById('expiration-date');
    const displayDateSpan = document.getElementById('selected-date-display');
    const durationBtns = document.querySelectorAll('.duration-btn');
    const generateCodeBtn = document.getElementById('generate-code-btn');
    const generateResult = document.getElementById('generate-result');
    const codesList = document.getElementById('codes-list');
    const filterContainer = document.getElementById('filter-container');
    const listCount = document.getElementById('list-count');

    // Edit Modal Elements
    const editModal = document.getElementById('edit-modal');
    const editCodeId = document.getElementById('edit-code-id');
    const editCodeDisplay = document.getElementById('edit-code-display');
    const editCreator = document.getElementById('edit-creator');
    const editPhone = document.getElementById('edit-phone');
    const editTags = document.getElementById('edit-tags');
    const editNotes = document.getElementById('edit-notes');
    const editExpiration = document.getElementById('edit-expiration');

    // ----------------------------------------------------------------
    // Logic
    // ----------------------------------------------------------------
    let expirationDays = 30;
    let isCustomDate = false;
    updateDateDisplay();

    durationBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        durationBtns.forEach(b => b.className = 'duration-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all');
        btn.className = 'duration-btn px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium transition-all ring-2 ring-primary ring-offset-1';

        const val = btn.dataset.value;
        const days = btn.dataset.days;
        if (val === 'custom') {
          isCustomDate = true;
          expirationDateInput.classList.remove('hidden');
          displayDateSpan.innerText = '';
        } else {
          isCustomDate = false;
          expirationDateInput.classList.add('hidden');
          expirationDays = parseInt(days);
          updateDateDisplay();
        }
      });
    });

    function updateDateDisplay() {
      const target = getKSTEndOfDay(expirationDays);
      displayDateSpan.innerText = `(~ ${target.toLocaleDateString()})`;
    }

    async function autoCleanupExpired() {
      const now = new Date();
      try {
        const snapshot = await db.collection('codes').where('expiresAt', '<', now).get();
        if (!snapshot.empty) {
          const batch = db.batch();
          snapshot.docs.forEach(doc => {
            batch.delete(db.collection('codes').doc(doc.id));
            batch.delete(db.collection('sessions').doc(doc.id));
          });
          await batch.commit();
          showToast(`${snapshot.size}ê°œì˜ ë§Œë£Œëœ ì½”ë“œ(ì„¸ì…˜ í¬í•¨)ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.`);
        }
      } catch (e) { console.error("Auto Cleanup Failed", e); }
    }

    function formatPhoneNumber(phone) { return phone.replace(/[-\s]/g, ''); }
    function validatePhoneNumber(phone) { return /^010\d{8}$/.test(formatPhoneNumber(phone)); }
    function generateRandomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) { code += chars.charAt(Math.floor(Math.random() * chars.length)); }
      return code;
    }
    function showToast(msg) {
      const el = document.createElement('div');
      el.className = 'bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl mb-2 animate-bounce';
      el.innerText = msg;
      document.getElementById('toast-container').appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }
    function showResult(message, type) {
      generateResult.className = `p-4 rounded-lg mt-4 ${type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' : 'bg-red-50 border border-red-200 text-red-700'}`;
      generateResult.innerHTML = message;
      generateResult.classList.remove('hidden');
      if (type === 'success') setTimeout(() => generateResult.classList.add('hidden'), 5000);
    }

    generateCodeBtn.addEventListener('click', async () => {
      const creatorName = creatorNameInput.value.trim();
      const parentPhone = formatPhoneNumber(parentPhoneInput.value.trim());
      const tags = tagsInput.value.trim();
      const notes = notesInput.value.trim();

      let expireDateObj;
      if (isCustomDate) {
        if (!expirationDateInput.value) return showResult('ë§Œë£Œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        expireDateObj = parseKSTDateInput(expirationDateInput.value);
      } else {
        expireDateObj = getKSTEndOfDay(expirationDays);
      }

      if (!creatorName || !parentPhone) return showResult('í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      if (!validatePhoneNumber(parentPhone)) return showResult('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');

      generateCodeBtn.disabled = true;
      generateCodeBtn.innerHTML = '<span class="material-symbols-rounded animate-spin">refresh</span> ìƒì„± ì¤‘...';

      try {
        let code, attempts = 0, maxAttempts = 100;
        while (attempts < maxAttempts) {
          code = generateRandomCode();
          const codeDoc = await db.collection('codes').doc(code).get();
          if (!codeDoc.exists) {
            const now = FieldValue.serverTimestamp();
            const batch = db.batch();
            batch.set(db.collection('codes').doc(code), {
              code, createdAt: now, createdBy: creatorName, parentPhone,
              tags: tags, notes: notes, expiresAt: expireDateObj, isActive: true
            });
            batch.set(db.collection('sessions').doc(code), {
              code, createdAt: now, createdBy: creatorName, activeConnections: 0, lastActivity: now
            });
            await batch.commit();
            showResult(`ì½”ë“œ ìƒì„± ì™„ë£Œ: <strong class="font-mono text-lg">${code}</strong>`, 'success');
            creatorNameInput.value = ''; parentPhoneInput.value = ''; tagsInput.value = ''; notesInput.value = '';
            loadCodes();
            return;
          }
          attempts++;
        }
        showResult('ì½”ë“œ ìƒì„± ì‹¤íŒ¨.', 'error');
      } catch (error) {
        console.error(error);
        showResult('ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
      } finally {
        generateCodeBtn.disabled = false;
        generateCodeBtn.innerHTML = '<span class="material-symbols-rounded">refresh</span> ì½”ë“œ ìƒì„±';
      }
    });

    async function loadCodes() {
      try {
        const snapshot = await db.collection('codes').orderBy('createdAt', 'desc').get();
        allCodes = [];
        snapshot.forEach(doc => allCodes.push({ id: doc.id, ...doc.data() }));
        renderFilterBar();
        renderList();
      } catch (error) {
        console.error(error);
        codesList.innerHTML = '<div class="text-center text-red-500">ë¡œë“œ ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œ ë“±)</div>';
      }
    }

    function renderFilterBar() {
      const tagSet = new Set();
      allCodes.forEach(item => {
        if (item.tags) {
          item.tags.split(/[\s,]+/).filter(t => t.length > 0).forEach(t => tagSet.add(t.startsWith('#') ? t : '#' + t));
        }
      });
      let html = `<button onclick="setFilter('All')" class="px-3 py-1.5 rounded-full text-sm font-medium border ${currentFilter === 'All' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600'}">ì „ì²´</button>`;
      Array.from(tagSet).sort().forEach(tag => {
        const active = currentFilter === tag;
        html += `<button onclick="setFilter('${tag}')" class="px-3 py-1.5 rounded-full text-sm font-medium border ${active ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600'}">${tag}</button>`;
      });
      filterContainer.innerHTML = html;
    }

    window.setFilter = function (tag) { currentFilter = tag; renderFilterBar(); renderList(); }

    function renderList() {
      const now = new Date();
      codesList.innerHTML = '';
      const filtered = currentFilter === 'All' ? allCodes : allCodes.filter(item => {
        const t = item.tags || '';
        return t.split(/[\s,]+/).map(x => x.startsWith('#') ? x : '#' + x).includes(currentFilter);
      });
      listCount.innerText = `(${filtered.length}ê°œ)`;

      if (filtered.length === 0) {
        codesList.innerHTML = '<div class="text-center py-8 text-slate-500">í‘œì‹œí•  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      filtered.forEach(data => {
        const code = data.id;
        const tags = (data.tags || '').split(/[\s,]+/).filter(t => t.length > 0).map(t => t.startsWith('#') ? t : '#' + t);
        const notes = data.notes || '';
        const parentPhone = (data.parentPhone || '').replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');

        // Issued Date (Restored)
        const createdAt = data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date();
        const createdDateStr = createdAt.toLocaleDateString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit' });

        // Expiration
        let expiresAtDate = data.expiresAt ? (data.expiresAt.toDate ? data.expiresAt.toDate() : new Date(data.expiresAt)) : null;
        let isExpired = expiresAtDate && expiresAtDate < now;
        let dateStr = expiresAtDate ? expiresAtDate.toLocaleDateString('ko-KR') : 'ê¸°í•œ ì—†ìŒ';

        let statusLabel = '';
        if (isExpired) statusLabel = `<span class="px-2 py-0.5 bg-slate-200 text-slate-500 text-xs rounded-full font-bold ml-2">ë§Œë£Œë¨</span>`;
        if (expiresAtDate && !isExpired) {
          const diffDays = Math.ceil((expiresAtDate - now) / (1000 * 60 * 60 * 24));
          statusLabel = `<span class="px-2 py-0.5 ${diffDays <= 7 ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'} text-xs rounded-full font-bold ml-2">D-${diffDays}</span>`;
        }

        const tagsHtml = tags.map(tag => `<span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded text-xs border border-indigo-100 mr-1">${tag}</span>`).join('');
        const notesHtml = notes ? `<div class="mt-2 text-sm text-slate-600 bg-white p-2 rounded border border-slate-100 flex gap-2"><span class="font-bold text-xs text-slate-400 shrink-0 mt-0.5">NOTE</span><span class="break-all">${notes}</span></div>` : '';

        const codeItem = document.createElement('div');
        codeItem.className = `code-item bg-slate-50 rounded-lg p-4 border border-slate-200 relative ${isExpired ? 'expired-item' : ''}`;
        codeItem.innerHTML = `
          <div class="flex flex-col gap-2">
            <div class="flex items-start justify-between">
              <div class="w-full">
                <div class="flex items-center flex-wrap mb-1">
                  <span class="font-mono text-xl font-bold text-slate-900 mr-2">${code}</span>
                  <span class="text-sm font-medium text-slate-700 mr-1">${data.createdBy || 'Unknown'}</span>
                  ${statusLabel}
                </div>
                <div class="flex flex-wrap gap-1 mb-2">${tagsHtml}</div>
                <div class="text-xs text-slate-500 flex flex-wrap gap-x-4 gap-y-1 items-center">
                   <span class="flex items-center gap-1" title="ë°œê¸‰ì¼"><span class="material-symbols-rounded text-xs">history</span> ${createdDateStr}</span>
                   <span class="flex items-center gap-1" title="ë§Œë£Œì¼"><span class="material-symbols-rounded text-xs">event</span> ${dateStr}</span>
                   <span class="flex items-center gap-1"><span class="material-symbols-rounded text-xs">phone</span> ${parentPhone}</span>
                </div>
              </div>
              <div class="flex items-start gap-1 shrink-0 ml-2">
                <button class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" onclick="openEditModal('${code}')"><span class="material-symbols-rounded">edit</span></button>
                <button class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg" onclick="deleteCode('${code}')"><span class="material-symbols-rounded">delete</span></button>
              </div>
            </div>
            ${notesHtml}
          </div>
        `;
        codesList.appendChild(codeItem);
      });
    }

    // Modal & Global Actions
    window.openEditModal = function (code) {
      const item = allCodes.find(c => c.id === code);
      if (!item) return;
      editCodeId.value = code; editCodeDisplay.value = code; editCreator.value = item.createdBy;
      editPhone.value = item.parentPhone; editTags.value = item.tags || ''; editNotes.value = item.notes || '';
      if (item.expiresAt) {
        const d = item.expiresAt.toDate ? item.expiresAt.toDate() : new Date(item.expiresAt);
        editExpiration.value = d.toISOString().split('T')[0];
      }
      editModal.showModal();
    }
    window.closeEditModal = () => editModal.close();
    window.saveEdit = async function () {
      const code = editCodeId.value;
      const updateData = { parentPhone: formatPhoneNumber(editPhone.value), tags: editTags.value, notes: editNotes.value };
      if (editExpiration.value) updateData.expiresAt = parseKSTDateInput(editExpiration.value);
      try { await db.collection('codes').doc(code).update(updateData); showToast('ìˆ˜ì • ì„±ê³µ'); closeEditModal(); loadCodes(); } catch (e) { alert(e.message); }
    }
    window.deleteCode = async function (code) {
      if (!confirm(`ì½”ë“œ "${code}"ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        const batch = db.batch();
        batch.delete(db.collection('codes').doc(code));
        batch.delete(db.collection('sessions').doc(code));
        await batch.commit();
        loadCodes();
        showToast('ì‚­ì œ ì™„ë£Œ');
      } catch (e) { alert(e.message); }
    }
    document.getElementById('refresh-btn').addEventListener('click', loadCodes);
  </script>
</body>

</html>